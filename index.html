<!DOCTYPE html><html lang="si" data-theme="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>RansGPT - AI Assistant by Ransara Devnath</title><meta name="description" content="RansGPT is a personalized AI chat assistant, trained and developed by Ransara Devnath, offering intelligent conversations and answers."><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" defer></script><script src="https://identity.netlify.com/v1/netlify-identity-widget.js" defer></script><script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js" defer></script><style>:root{--background-color:#131314;--surface-color:#1E1F20;--text-color:#E3E3E3;--secondary-text-color:#9AA0A6;--accent-color:#8AB4F8;--font-family:'Roboto',sans-serif;--hover-color:#282A2C;--sidebar-width:280px;--danger-color:#e57373}[data-theme=light]{--background-color:#fff;--surface-color:#F0F4F9;--text-color:#1F1F1F;--secondary-text-color:#5F6368;--hover-color:#E8F0FE;--danger-color:#d32f2f}*{margin:0;padding:0;box-sizing:border-box}body{font-family:var(--font-family);background-color:var(--background-color);color:var(--text-color);display:flex;height:100vh;overflow:hidden}.sidebar{position:fixed;top:0;left:0;width:var(--sidebar-width);height:100%;background-color:var(--surface-color);z-index:1001;transform:translateX(-100%);transition:transform .3s ease;padding:16px;display:flex;flex-direction:column;border-right:1px solid var(--hover-color)}.sidebar.open{transform:translateX(0)}.sidebar-header{display:flex;align-items:center;gap:12px;margin-bottom:24px}.sidebar-header .close-btn{background:0 0;border:none;color:var(--text-color);font-size:20px;cursor:pointer}.sidebar-header .title{font-size:20px;font-weight:500}.sidebar-content{flex-grow:1;overflow-y:auto}.sidebar-section{margin-bottom:20px}.sidebar-section h3{font-size:14px;color:var(--secondary-text-color);margin-bottom:10px;padding:0 12px}.sidebar-list{list-style:none}.sidebar-list li{display:flex;align-items:center;width:100%;gap:16px;padding:10px 12px;border-radius:20px;cursor:pointer;transition:background-color .2s;font-size:14px}.sidebar-list li:hover{background-color:var(--hover-color)}.sidebar-list li.active{background-color:var(--accent-color);color:var(--background-color)}.sidebar-list li i{width:20px;text-align:center}.sidebar-credit{margin-top:auto;padding:20px 0 10px;text-align:center;font-size:12px;color:var(--secondary-text-color)}.sidebar-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);z-index:1000;opacity:0;pointer-events:none;transition:opacity .3s ease}.sidebar-overlay.open{opacity:1;pointer-events:auto}.app-container{width:100%;display:flex;flex-direction:column;height:100vh}.top-bar{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;flex-shrink:0;position:relative}.top-bar .menu-icon{font-size:20px;cursor:pointer;color:var(--text-color)}.profile-icon-container{position:relative}.profile-icon{background-color:var(--surface-color);width:32px;height:32px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:18px;cursor:pointer;border:1px solid var(--secondary-text-color);object-fit:cover}.profile-dropdown{position:absolute;top:45px;right:0;background-color:var(--surface-color);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.3);z-index:1002;width:200px;padding:8px;display:none}.profile-dropdown.show{display:block}.profile-dropdown ul{list-style:none}.profile-dropdown li{padding:10px 12px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:10px;font-size:14px}.profile-dropdown li:hover{background-color:var(--hover-color)}.profile-dropdown li.danger:hover{background-color:var(--danger-color);color:#fff}.top-bar .title{font-size:20px;font-weight:500}.main-content{flex-grow:1;overflow-y:auto;padding:0 16px;display:flex;flex-direction:column;align-items:center}.content-wrapper{width:100%;max-width:800px;padding-top:24px;padding-bottom:20px}.greeting{animation:fadeInUp .8s ease-out forwards}@keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.greeting h1{font-size:clamp(2rem,10vw,3.5rem);font-weight:400;background:-webkit-linear-gradient(45deg,#4285f4,#9b72cb,#d96570,#f2a600);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}.greeting p{font-size:1.25rem;color:var(--secondary-text-color)}.suggestion-cards,.chat-box{width:100%;max-width:800px}.suggestion-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:40px}.card{background-color:var(--surface-color);border-radius:12px;padding:16px;cursor:pointer;transition:background-color .2s,transform .2s;height:100px;position:relative;overflow:hidden}.card:hover{background-color:var(--hover-color);transform:translateY(-4px)}.card p{font-size:14px}.card .card-icon{position:absolute;bottom:12px;right:12px;font-size:24px;color:var(--secondary-text-color);background-color:var(--background-color);border-radius:50%;width:40px;height:40px;display:flex;justify-content:center;align-items:center}.chat-box{padding:20px 0;display:none;flex-direction:column}.message{margin-bottom:24px;display:flex;align-items:flex-start;gap:16px;max-width:90%;animation:fadeIn .5s ease-out}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.message.bot{align-self:flex-start}.message.user{align-self:flex-end;flex-direction:row-reverse}.message .avatar{width:32px;height:32px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-weight:700;flex-shrink:0;object-fit:cover}.message.user .avatar{background-color:var(--surface-color);font-size:16px}.message.bot .avatar{background:0 0}.message-content{display:flex;flex-direction:column;width:100%;position:relative}.message.user .message-content{align-items:flex-end}.message-content p{padding-top:4px;line-height:1.6;white-space:pre-wrap;word-wrap:break-word}.message p a.chat-link{color:var(--accent-color);text-decoration:underline}.message p b,.message p strong{font-weight:700}.message p em,.message p i{font-style:italic}.message p code:not(pre>code){background-color:var(--hover-color);border-radius:4px;padding:2px 6px;font-family:monospace;font-size:.9em}.code-block{background-color:#0d0d0d;border-radius:12px;margin:12px 0;overflow:hidden;border:1px solid #333}.code-block-header{display:flex;justify-content:space-between;align-items:center;background-color:#282a2c;padding:8px 12px;font-size:12px;color:var(--secondary-text-color);text-transform:uppercase}.copy-code-btn{background:0 0;border:none;color:var(--secondary-text-color);cursor:pointer;padding:4px 8px;border-radius:6px;display:flex;align-items:center;gap:6px}.copy-code-btn:hover{background-color:var(--hover-color);color:var(--text-color)}.message p pre{margin:0;border-radius:0}.message p pre code.hljs{padding:16px}.message p ol,.message p ul{margin-left:20px;margin-top:10px;margin-bottom:10px}.message p li{margin-bottom:5px}.thinking-animation{display:flex;align-items:center;gap:10px;padding:10px 0}.typing-dot{width:8px;height:8px;background-color:var(--secondary-text-color);border-radius:50%;animation:bounce 1.4s infinite ease-in-out both}.typing-dot:nth-child(1){animation-delay:-.32s}.typing-dot:nth-child(2){animation-delay:-.16s}@keyframes bounce{0%,100%,80%{transform:scale(0)}40%{transform:scale(1)}}.message-actions{display:flex;gap:8px;align-items:center;margin-top:8px;opacity:0;transition:opacity .2s linear;height:24px}.message:hover .message-actions{opacity:1}.action-icon{cursor:pointer;color:var(--secondary-text-color);padding:4px;font-size:16px}.input-area{padding:8px 16px 16px;background-color:var(--background-color);flex-shrink:0;width:100%;position:relative}.input-wrapper{max-width:800px;margin:0 auto;display:flex;flex-direction:column}.input-controls{display:flex;align-items:center;background-color:var(--surface-color);border-radius:28px;padding:4px 12px;width:100%}.input-controls #user-input{flex-grow:1;border:none;background:0 0;color:var(--text-color);padding:12px;font-size:16px;outline:0;resize:none;max-height:100px;overflow-y:auto}.icon-btn{background:0 0;border:none;color:var(--secondary-text-color);font-size:20px;cursor:pointer;padding:8px;border-radius:50%;transition:background-color .2s,color .2s;display:flex;justify-content:center;align-items:center}.icon-btn:hover{background-color:var(--hover-color)}#mic-btn.is-listening{color:var(--danger-color)}#send-btn.is-stopping{background-color:var(--hover-color);border:1px solid var(--secondary-text-color)}.disclaimer{font-size:12px;color:var(--secondary-text-color);text-align:center;padding-top:10px;max-width:800px;margin:0 auto}#file-preview-container{background-color:var(--surface-color);padding:8px;border-radius:16px;margin-bottom:10px;display:none;align-self:flex-start;max-width:300px;position:relative;animation:fadeIn .3s}.file-preview-wrapper{display:flex;align-items:center;gap:10px}.file-preview{width:60px;height:60px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:30px;color:var(--secondary-text-color);flex-shrink:0}.file-preview img{width:100%;height:100%;object-fit:cover;border-radius:12px}.file-info{display:flex;flex-direction:column;gap:4px;overflow:hidden}.file-info span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.file-name{font-size:14px;color:var(--text-color)}.file-size{font-size:12px;color:var(--secondary-text-color)}#remove-file-btn{position:absolute;top:0;right:0;background-color:rgba(0,0,0,.7);color:#fff;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;line-height:1;padding:0;transform:translate(25%,-25%)}.message-content .sent-file img{border-radius:12px;margin-top:8px;max-width:300px;max-height:300px;object-fit:contain;cursor:pointer;background-color:var(--hover-color)}</style></head><body><aside class="sidebar" id="sidebar"><div class="sidebar-header"><button class="close-btn" id="close-sidebar-btn"><i class="fas fa-times"></i></button><div class="title">RansGPT</div></div><div class="sidebar-content"><ul class="sidebar-list"><li id="new-chat-btn"><i class="fas fa-edit"></i> New Chat</li></ul><div class="sidebar-section"><h3>Recent</h3><ul class="sidebar-list" id="recent-chats-list"></ul></div><div class="sidebar-section"><h3>Settings</h3><ul class="sidebar-list"><li><div style="display:flex;align-items:center;justify-content:space-between;width:100%"><span><i class="fas fa-moon"></i> Dark Theme</span><label class="switch"><input type="checkbox" id="theme-toggle"><span class="slider"></span></label></div></li></ul></div></div><div class="sidebar-credit">Made by Ransara Devnath</div></aside><div class="sidebar-overlay" id="sidebar-overlay"></div><div class="app-container"><div class="top-bar"><div class="menu-icon" id="menu-icon"><i class="fas fa-bars"></i></div><div class="title">RansGPT</div><div class="profile-icon-container" id="profile-icon-container"><div class="profile-icon"><i class="fas fa-user"></i></div></div></div><main class="main-content" id="main-content"><div class="content-wrapper"><div id="welcome-container"><div class="greeting"><h1>Hello, Guest</h1><p>How can I help you today?</p></div><div class="suggestion-cards"><div class="card" data-prompt="Write a short story about a friendly robot"><p>Write a short story about a friendly robot</p><div class="card-icon"><i class="fas fa-pen"></i></div></div><div class="card" data-prompt="Explain quantum computing in simple terms"><p>Explain quantum computing in simple terms</p><div class="card-icon"><i class="fas fa-lightbulb"></i></div></div><div class="card" data-prompt="Suggest some fun activities for a weekend trip"><p>Suggest some fun activities for a weekend trip</p><div class="card-icon"><i class="fas fa-compass"></i></div></div><div class="card" data-prompt="Create a workout plan for a beginner"><p>Create a workout plan for a beginner</p><div class="card-icon"><i class="fas fa-dumbbell"></i></div></div></div></div><div class="chat-box" id="chat-box"></div></div></main><div class="input-area" id="input-area"><div class="input-wrapper"><div id="file-preview-container"></div><div class="input-controls"><label for="file-upload" class="icon-btn" title="Attach File"><i class="fas fa-paperclip"></i></label><input type="file" id="file-upload" style="display:none"><input type="text" id="user-input" placeholder="Ask RansGPT"><button class="icon-btn" id="mic-btn" title="Voice Input"><i class="fas fa-microphone"></i></button><button class="icon-btn" id="send-btn" title="Send" style="display:none"><i class="fas fa-arrow-up"></i></button></div></div><p class="disclaimer">RansGPT can make mistakes. Consider checking important information.</p></div></div><div class="toast" id="toast"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Elements ---
    const mainContent = document.getElementById('main-content');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const menuIcon = document.getElementById('menu-icon');
    const closeSidebarBtn = document.getElementById('close-sidebar-btn');
    const welcomeContainer = document.getElementById('welcome-container');
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const micBtn = document.getElementById('mic-btn');
    const suggestionCards = document.querySelectorAll('.card');
    const fileUploadInput = document.getElementById('file-upload');
    const filePreviewContainer = document.getElementById('file-preview-container');
    const themeToggle = document.getElementById('theme-toggle');
    const recentChatsList = document.getElementById('recent-chats-list');
    const newChatBtn = document.getElementById('new-chat-btn');
    const profileIconContainer = document.getElementById('profile-icon-container');
    const toast = document.getElementById('toast');

    // --- State Management ---
    let currentChat = [];
    let allChats = {};
    let currentChatId = null;
    let lastUserMessage = {};
    let apiRequestController;
    let attachedFile = null;
    let speechRecognition;

    // --- Core Functions ---
    function showToast(message) {
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => { toast.classList.remove('show'); }, 3000);
    }

    function addMessage(messageData) {
        const { id, text, sender, isThinking = false, file } = messageData;
        showChatView();
        const user = netlifyIdentity.currentUser();
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', sender);
        messageElement.dataset.id = id;
        
        let avatarHTML;
        if (sender === 'user') {
            const userAvatarSrc = user?.user_metadata?.avatar || 'icon';
            avatarHTML = (userAvatarSrc === 'icon') ?
                `<div class="avatar"><i class="fas fa-user"></i></div>` :
                `<img class="avatar" src="${userAvatarSrc}" alt="User Avatar">`;
        } else {
            avatarHTML = `<img class="avatar" src="https://files.catbox.moe/fj08ro.jpg" alt="RansGPT Logo">`;
        }
        
        const messageContent = document.createElement('div');
        messageContent.classList.add('message-content');

        if (isThinking) {
            messageContent.innerHTML = `<div class="thinking-animation"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
        } else {
            if (file && sender === 'user') {
                const fileElement = document.createElement('div');
                fileElement.classList.add('sent-file');
                if (file.type.startsWith('image/')) {
                    fileElement.innerHTML = `<img src="${file.url}" alt="${file.name}">`;
                } else {
                     fileElement.innerHTML = `<div class="file-preview-wrapper"><div class="file-preview"><i class="fas fa-file-alt"></i></div><div class="file-info"><span class="file-name">${file.name}</span></div></div>`;
                }
                messageContent.appendChild(fileElement);
            }
            if (text) {
                const p = document.createElement('p');
                if (sender === 'bot') {
                    const dirtyHtml = marked.parse(text);
                    p.innerHTML = DOMPurify.sanitize(dirtyHtml);
                    p.querySelectorAll('pre code').forEach((block) => {
                        const language = (block.className.match(/language-(\w+)/) || [])[1] || 'code';
                        
                        const codeBlockWrapper = document.createElement('div');
                        codeBlockWrapper.className = 'code-block';

                        const header = document.createElement('div');
                        header.className = 'code-block-header';
                        
                        const langName = document.createElement('span');
                        langName.textContent = language;

                        const copyBtn = document.createElement('button');
                        copyBtn.className = 'copy-code-btn';
                        copyBtn.innerHTML = '<i class="far fa-copy"></i> Copy';
                        copyBtn.onclick = () => {
                            navigator.clipboard.writeText(block.innerText);
                            showToast('Code copied!');
                        };
                        header.appendChild(langName);
                        header.appendChild(copyBtn);

                        codeBlockWrapper.appendChild(header);
                        // Move the <pre> element inside the wrapper
                        const preElement = block.parentElement;
                        preElement.parentNode.replaceChild(codeBlockWrapper, preElement);
                        codeBlockWrapper.appendChild(preElement);
                        
                        hljs.highlightElement(block);
                    });
                } else {
                    p.textContent = text;
                }
                messageContent.appendChild(p);
            }
            if (sender === 'bot') {
                const actionsContainer = document.createElement('div');
                actionsContainer.classList.add('message-actions');
                actionsContainer.innerHTML = `<i class="fas fa-sync-alt action-icon regenerate-btn" title="Regenerate"></i>`;
                messageContent.appendChild(actionsContainer);
                actionsContainer.querySelector('.regenerate-btn').addEventListener('click', () => handleRegenerate(id));
            }
        }
        
        messageElement.innerHTML = avatarHTML;
        messageElement.appendChild(messageContent);
        chatBox.appendChild(messageElement);
        mainContent.scrollTop = mainContent.scrollHeight;
    }

    function handleRegenerate(botMessageId) {
        const botMsgIndex = currentChat.findIndex(m => m.id === botMessageId);
        if (botMsgIndex < 1) return;

        const userMsgIndex = botMsgIndex - 1;
        const userMessage = currentChat[userMsgIndex];

        const userMsgElement = document.querySelector(`[data-id='${userMessage.id}']`);
        if (userMsgElement) {
            let elementToRemove = userMsgElement.nextElementSibling;
            while (elementToRemove && !elementToRemove.classList.contains('message-user')) {
                let nextElement = elementToRemove.nextElementSibling;
                elementToRemove.remove();
                elementToRemove = nextElement;
            }
            userMsgElement.remove();
        }

        currentChat.splice(userMsgIndex);
        showToast("Switching model and regenerating...");
        sendMessage(userMessage.text, userMessage.file, true);
    }

    async function sendMessage(queryText, fileInfo, isRegenerating = false) {
        if (sendBtn.classList.contains('is-stopping')) {
            if (apiRequestController) {
                apiRequestController.abort();
            }
            return;
        }

        const query = queryText !== undefined ? queryText : userInput.value.trim();
        const file = fileInfo !== undefined ? fileInfo : attachedFile;
        const finalText = (query === '' && file) ? `Tell me about this ${file.type.startsWith('image/') ? 'image' : 'file'}.` : query;
        
        if (finalText === '' && !file) return;

        const userMessageId = 'user-' + Date.now();
        const userMessage = { id: userMessageId, sender: 'user', text: finalText, file: file };
        lastUserMessage = { ...userMessage };

        addMessage(userMessage);
        currentChat.push(userMessage);

        userInput.value = '';
        removeFilePreview();
        toggleSendButton(true);

        const thinkingMessageId = 'bot-thinking-' + Date.now();
        addMessage({ id: thinkingMessageId, sender: 'bot', isThinking: true });

        apiRequestController = new AbortController();
        try {
            const bodyPayload = { history: currentChat, regenerate: isRegenerating };
            const response = await fetch('/.netlify/functions/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(bodyPayload), signal: apiRequestController.signal });
            
            if (!response.ok) throw new Error(`Network error: ${response.status}`);
            
            const data = await response.json();
            document.querySelector(`[data-id='${thinkingMessageId}']`)?.remove();
            
            const botMessageId = 'bot-' + Date.now();
            const botMessage = { id: botMessageId, sender: 'bot', text: data.reply, modelUsed: data.model };
            addMessage(botMessage);
            currentChat.push(botMessage);
            
            saveCurrentChat();

        } catch (error) {
            document.querySelector(`[data-id='${thinkingMessageId}']`)?.remove();
            if (error.name === 'AbortError') {
                addMessage({ id: 'bot-stopped-' + Date.now(), sender: 'bot', text: "Response stopped." });
                userInput.value = lastUserMessage.text || '';
            } else {
                addMessage({ id: 'bot-error-' + Date.now(), sender: 'bot', text: 'Sorry, an error occurred.' });
                console.error('Error:', error);
            }
        } finally {
            apiRequestController = null;
            toggleSendButton(false);
        }
    }

    function handleVoiceInput() {
        if (!('webkitSpeechRecognition' in window)) {
            showToast('Sorry, your browser does not support voice input.');
            return;
        }
        
        if (speechRecognition && speechRecognition.isListening) {
            speechRecognition.stop();
            return;
        }

        const SpeechRecognition = window.webkitSpeechRecognition;
        speechRecognition = new SpeechRecognition();
        speechRecognition.continuous = false;
        speechRecognition.lang = 'en-US';
        speechRecognition.interimResults = false;

        speechRecognition.onstart = () => {
            speechRecognition.isListening = true;
            micBtn.classList.add('is-listening');
        };

        speechRecognition.onend = () => {
            speechRecognition.isListening = false;
            micBtn.classList.remove('is-listening');
        };

        speechRecognition.onerror = (event) => {
            console.error("Speech recognition error", event);
            if (event.error !== 'no-speech') showToast("Sorry, I didn't catch that.");
        };
        
        speechRecognition.onresult = (event) => {
            userInput.value = event.results[0][0].transcript;
            toggleSendButton(false);
        };
        
        speechRecognition.start();
    }
    
    function showFilePreview(file) {
        const { name, size, type, url } = file;
        const fileSize = size > 1024 * 1024 ? `${(size / (1024 * 1024)).toFixed(2)} MB` : `${(size / 1024).toFixed(1)} KB`;
        
        let previewHTML = type.startsWith('image/') ? `<img src="${url}" alt="Preview">` : `<i class="fas fa-file-alt"></i>`;

        filePreviewContainer.innerHTML = `
            <div class="file-preview-wrapper">
                <div class="file-preview">${previewHTML}</div>
                <div class="file-info">
                    <span class="file-name" title="${name}">${name}</span>
                    <span class="file-size">${fileSize}</span>
                </div>
            </div>
            <button id="remove-file-btn">&times;</button>
        `;
        filePreviewContainer.style.display = 'block';
        document.getElementById('remove-file-btn').addEventListener('click', removeFilePreview);

        if (size > 6 * 1024 * 1024) {
            showToast("Warning: Large files can't be processed by the AI.");
        }
    }

    function removeFilePreview() {
        attachedFile = null;
        fileUploadInput.value = '';
        filePreviewContainer.innerHTML = '';
        filePreviewContainer.style.display = 'none';
        toggleSendButton(false);
    }
    
    function toggleSendButton(isSending = false) {
        const hasContent = userInput.value.trim() !== '' || attachedFile;
        if (isSending) {
            micBtn.style.display = 'none';
            sendBtn.style.display = 'flex';
            sendBtn.classList.add('is-stopping');
            sendBtn.innerHTML = `<i class="fas fa-stop"></i>`;
        } else {
            sendBtn.classList.remove('is-stopping');
            sendBtn.innerHTML = `<i class="fas fa-arrow-up"></i>`;
            if (hasContent) {
                micBtn.style.display = 'none';
                sendBtn.style.display = 'flex';
            } else {
                micBtn.style.display = 'flex';
                sendBtn.style.display = 'none';
            }
        }
    }
    
    // --- UI, Auth, and Helper Functions ---
    function updateUI(user){profileIconContainer.innerHTML = '';const userAvatarSrc=user?user.user_metadata.avatar||'icon':'icon';let profileIcon;if(userAvatarSrc==='icon'){profileIcon=document.createElement('div');profileIcon.classList.add('profile-icon');profileIcon.innerHTML=`<i class="fas fa-user"></i>`;}else{profileIcon=document.createElement('img');profileIcon.classList.add('profile-icon');profileIcon.src=userAvatarSrc;}profileIcon.addEventListener('click',e=>{e.stopPropagation();toggleProfileDropdown(user);});profileIconContainer.appendChild(profileIcon);if(user){greetingH1.textContent=`Hello, ${user.user_metadata.full_name||user.user_metadata.name||user.email.split('@')[0]}`;loadUserSpecificData(user);}else{showWelcomeView();greetingH1.textContent=`Hello, Guest`;recentChatsList.innerHTML='';}}
    function toggleProfileDropdown(user){let dropdown=document.getElementById('profile-dropdown');if(!dropdown){dropdown=document.createElement('div');dropdown.id='profile-dropdown';dropdown.classList.add('profile-dropdown');profileIconContainer.appendChild(dropdown);}const ul=document.createElement('ul');if(user){ul.innerHTML=`<li id="settings-btn"><i class="fas fa-cog"></i> Settings</li><li id="logout-btn" class="danger"><i class="fas fa-sign-out-alt"></i> Logout</li>`;}else{ul.innerHTML=`<li id="login-btn"><i class="fas fa-sign-in-alt"></i> Login / Sign Up</li>`;}dropdown.innerHTML='';dropdown.appendChild(ul);if(user){dropdown.querySelector('#settings-btn').addEventListener('click',openAccountModal);dropdown.querySelector('#logout-btn').addEventListener('click',()=>{netlifyIdentity.logout();dropdown.classList.remove('show');});}else{dropdown.querySelector('#login-btn').addEventListener('click',()=>{netlifyIdentity.open();dropdown.classList.remove('show');});}dropdown.classList.toggle('show');}
    function showWelcomeView(){ welcomeContainer.style.display='block';chatBox.style.display='none';chatBox.innerHTML='';}
    function showChatView(isNewChat = false){if(isNewChat||welcomeContainer.style.display!=='none'){welcomeContainer.style.display='none';chatBox.style.display='flex';chatBox.style.flexDirection='column';}}
    function setTheme(theme){document.documentElement.setAttribute('data-theme',theme);localStorage.setItem('ransgpt_theme',theme);themeToggle.checked=theme==='dark';}
    function toggleSidebar(){ sidebar.classList.toggle('open');sidebarOverlay.classList.toggle('open');}
    function saveCurrentChat(){const user=netlifyIdentity.currentUser();if(!user||currentChat.length===0)return;if(!currentChatId){currentChatId='chat-'+Date.now();}const firstUserMessage=currentChat.find(msg=>msg.sender==='user');const title=firstUserMessage?(firstUserMessage.text||"File Query").split(' ').slice(0,5).join(' '):"New Chat";allChats[currentChatId]={title:title,messages:currentChat};localStorage.setItem(`ransgpt_chats_${user.id}`,JSON.stringify(allChats));updateRecentChatsList(user.id);}
    function updateRecentChatsList(userId){recentChatsList.innerHTML='';if(!userId)return;const chatIds=Object.keys(allChats).reverse();chatIds.forEach(chatId=>{const li=document.createElement('li');const chat=allChats[chatId];li.dataset.id=chatId;const titleWrapper=document.createElement('div');titleWrapper.classList.add('chat-title-wrapper');titleWrapper.innerHTML=`<i class="far fa-comment-alt"></i><span class="chat-title-text">${chat.title}</span>`;const deleteBtn=document.createElement('i');deleteBtn.classList.add('fas','fa-trash-alt','delete-chat-btn');li.appendChild(titleWrapper);li.appendChild(deleteBtn);if(chatId===currentChatId){li.classList.add('active');}titleWrapper.addEventListener('click',()=>loadChat(chatId));deleteBtn.addEventListener('click',e=>{e.stopPropagation();showConfirmationToast(`Delete "${chat.title}"?`,()=>{const user=netlifyIdentity.currentUser();delete allChats[chatId];localStorage.setItem(`ransgpt_chats_${user.id}`,JSON.stringify(allChats));if(chatId===currentChatId){startNewChat();}else{updateRecentChatsList(user.id);}});});recentChatsList.appendChild(li);});}
    function loadChat(chatId){const user=netlifyIdentity.currentUser();if(!user||!allChats[chatId])return;currentChatId=chatId;currentChat=allChats[chatId].messages;chatBox.innerHTML='';showChatView(true);currentChat.forEach(msg=>addMessage(msg));updateRecentChatsList(user.id);if(sidebar.classList.contains('open')){toggleSidebar();}}
    function startNewChat(){const user=netlifyIdentity.currentUser();if(!user){netlifyIdentity.open();return;}currentChat=[];currentChatId=null;showWelcomeView();updateRecentChatsList(user.id);if(sidebar.classList.contains('open')){toggleSidebar();}}
    function loadUserSpecificData(user){const savedChats=localStorage.getItem(`ransgpt_chats_${user.id}`);allChats=savedChats?JSON.parse(savedChats):{};updateRecentChatsList(user.id);const savedTheme=localStorage.getItem('ransgpt_theme')||'dark';setTheme(savedTheme);}

    // Dummy functions for elements not in the provided HTML but might be in user's full version
    function openAccountModal() { showToast("Account settings clicked!"); }
    
    // --- Event Listeners ---
    menuIcon.addEventListener('click', toggleSidebar);
    closeSidebarBtn.addEventListener('click', toggleSidebar);
    sidebarOverlay.addEventListener('click', toggleSidebar);
    newChatBtn.addEventListener('click', startNewChat);
    sendBtn.addEventListener('click', () => sendMessage());
    userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
    userInput.addEventListener('input', () => toggleSendButton(false));
    micBtn.addEventListener('click', handleVoiceInput);
    suggestionCards.forEach(card => card.addEventListener('click', () => { const user = netlifyIdentity.currentUser(); if (!user) { netlifyIdentity.open(); return; } sendMessage(card.getAttribute('data-prompt')); }));
    fileUploadInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            attachedFile = { name: file.name, size: file.size, type: file.type, url: e.target.result };
            showFilePreview(attachedFile);
            toggleSendButton(false);
        };
        reader.readAsDataURL(file);
    });
    themeToggle.addEventListener('change', () => setTheme(themeToggle.checked ? 'dark' : 'light'));
    window.addEventListener('click', () => {const dropdown = document.getElementById('profile-dropdown');if (dropdown?.classList.contains('show')) dropdown.classList.remove('show');});
    
    // Initialize
    netlifyIdentity.on('init', user => updateUI(user));
    netlifyIdentity.on('login', user => { updateUI(user); netlifyIdentity.close(); });
    netlifyIdentity.on('logout', () => updateUI(null));
    setTheme(localStorage.getItem('ransgpt_theme') || 'dark');
});
</script>
</body></html>