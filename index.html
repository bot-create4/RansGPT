<!DOCTYPE html>
<html lang="si" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>RansGPT - AI Assistant by Ransara Devnath</title>
    
    <meta name="description" content="RansGPT is a smart Sinhala & English AI chat assistant created by Ransara Devnath.">
    <meta name="keywords" content="RansGPT, Ransara Devnath, AI Chatbot, Sinhala AI">
    <meta name="author" content="Ransara Devnath">
    <meta property="og:title" content="RansGPT - AI Assistant">
    <meta property="og:image" content="https://files.catbox.moe/fj08ro.jpg">
    <meta property="og:type" content="website">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>

    <style>
        /* --- THEME VARIABLES --- */
        :root{
            --background-color:#131314;
            --surface-color:#1E1F20;
            --text-color:#E3E3E3;
            --secondary-text-color:#9AA0A6;
            --accent-color:#8AB4F8;
            --font-family:'Roboto',sans-serif;
            --mono-font:'Roboto Mono', monospace;
            --hover-color:#282A2C;
            --sidebar-width:280px;
            --danger-color:#e57373;
            --code-bg:#282a2c;
            --code-header-bg:#1e1f20;
            --link-color: #8AB4F8;
            --user-msg-bg: #2d2f31;
        }
        [data-theme=light]{
            --background-color:#ffffff;
            --surface-color:#F0F4F9;
            --text-color:#1F1F1F;
            --secondary-text-color:#5F6368;
            --hover-color:#E8F0FE;
            --danger-color:#d32f2f;
            --code-bg:#f5f5f5;
            --code-header-bg:#e0e0e0;
            --link-color: #1a73e8;
            --user-msg-bg: #e8eaed;
        }
        
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{font-family:var(--font-family);background-color:var(--background-color);color:var(--text-color);display:flex;height:100vh;height:100dvh;overflow:hidden}
        
        /* Sidebar */
        .sidebar{position:fixed;top:0;left:0;width:var(--sidebar-width);height:100%;background-color:var(--surface-color);z-index:1001;transform:translateX(-100%);transition:transform .3s ease;padding:16px;display:flex;flex-direction:column;border-right:1px solid var(--hover-color)}.sidebar.open{transform:translateX(0)}
        .sidebar-header{display:flex;align-items:center;gap:12px;margin-bottom:24px}
        .sidebar-header .close-btn{background:0 0;border:none;color:var(--text-color);font-size:20px;cursor:pointer}
        .sidebar-header .title{font-size:20px;font-weight:500}
        .sidebar-content{flex-grow:1;overflow-y:auto}
        .sidebar-section{margin-bottom:20px}.sidebar-section h3{font-size:14px;color:var(--secondary-text-color);margin-bottom:10px;padding:0 12px}
        .sidebar-list{list-style:none}.sidebar-list li{display:flex;align-items:center;width:100%;gap:16px;padding:10px 12px;border-radius:20px;cursor:pointer;transition:background-color .2s;font-size:14px}
        .sidebar-list li:hover{background-color:var(--hover-color)}.sidebar-list li.active{background-color:var(--accent-color);color:var(--background-color)}.sidebar-list li i{width:20px;text-align:center}
        .sidebar-credit{margin-top:auto;padding:20px 0 10px;text-align:center;font-size:12px;color:var(--secondary-text-color)}
        .sidebar-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);z-index:1000;opacity:0;pointer-events:none;transition:opacity .3s ease}.sidebar-overlay.open{opacity:1;pointer-events:auto}
        
        /* App Container */
        .app-container{width:100%;display:flex;flex-direction:column;height:100%;position:relative}
        .top-bar{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;flex-shrink:0}
        .top-bar .menu-icon{font-size:20px;cursor:pointer;color:var(--text-color);padding:8px}
        .top-bar .title{font-size:20px;font-weight:500}
        
        /* Profile & Dropdown (IMPROVED) */
        .profile-icon-container{position:relative}
        .profile-icon{background-color:var(--surface-color);width:32px;height:32px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:18px;cursor:pointer;border:1px solid var(--secondary-text-color);object-fit:cover}
        
        .profile-dropdown{
            position:absolute; top:45px; right:0;
            background-color:var(--surface-color);
            border-radius:12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            border: 1px solid var(--hover-color);
            z-index:1002; width:220px; padding:8px;
            display:none; transform-origin: top right;
            animation: scaleIn 0.2s ease-out;
        }
        @keyframes scaleIn { from{opacity:0; transform:scale(0.9);} to{opacity:1; transform:scale(1);} }
        .profile-dropdown.show{display:block}
        .profile-dropdown ul{list-style:none}
        .profile-dropdown li{padding:12px 16px;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:12px;font-size:14px; color: var(--text-color); transition: background 0.2s;}
        .profile-dropdown li:hover{background-color:var(--hover-color)}
        .profile-dropdown li.danger{color: var(--danger-color);}
        .profile-dropdown li.danger:hover{background-color:rgba(229, 115, 115, 0.1);}

        /* Main Content */
        .main-content{flex-grow:1;overflow-y:auto;padding:0 16px;display:flex;flex-direction:column;align-items:center;scroll-behavior: smooth;}
        .content-wrapper{width:100%;max-width:800px;padding-top:24px;padding-bottom:20px;flex-grow: 1;display: flex; flex-direction: column;}
        .greeting{animation:fadeInUp .8s ease-out forwards; text-align: center; margin-bottom: 20px;}@keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        .greeting h1{font-size:clamp(2rem,10vw,3.5rem);font-weight:400;background:-webkit-linear-gradient(45deg,#4285f4,#9b72cb,#d96570,#f2a600);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}
        .greeting p{font-size:1.25rem;color:var(--secondary-text-color)}
        
        /* Cards */
        .suggestion-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-top:20px;width:100%}
        .card{background-color:var(--surface-color);border-radius:12px;padding:16px;cursor:pointer;transition:background-color .2s;height:120px;position:relative;overflow:hidden;display:flex;flex-direction:column;justify-content:space-between}
        .card:hover{background-color:var(--hover-color)}
        .card p{font-size:14px;line-height:1.4}
        .card .card-icon{align-self:flex-end;font-size:20px;color:var(--secondary-text-color);background-color:var(--background-color);border-radius:50%;width:36px;height:36px;display:flex;justify-content:center;align-items:center}
        
        /* Chat Box */
        .chat-box{padding:10px 0;display:none;flex-direction:column;width: 100%;}
        .message{margin-bottom:24px;display:flex;align-items:flex-start;gap:12px;max-width:100%}
        .message.bot{align-self:flex-start; width: 100%;}
        .message.user{align-self:flex-end;flex-direction:row-reverse;max-width: 90%;}
        .message .avatar{width:30px;height:30px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-weight:700;flex-shrink:0;object-fit:cover;margin-top:2px}
        .message.user .avatar{background-color:var(--surface-color);font-size:14px}
        .message.bot .avatar{background:0 0}
        
        .message-content{display:flex;flex-direction:column;width:100%;position:relative; overflow-wrap: break-word; min-width: 0;}
        .message.user .message-content{align-items:flex-end}
        
        /* Message Text Styles */
        .message p {line-height:1.6;font-size:1rem;}
        .message.bot p { width: 100%; }
        .message.user p {background-color: var(--user-msg-bg); padding: 10px 16px; border-radius: 20px; border-top-right-radius: 4px; display: inline-block;}
        
        /* Images */
        .message .chat-image {max-width: 300px; width: 100%; border-radius: 12px; margin-bottom: 8px; border: 1px solid var(--secondary-text-color);}

        /* --- MARKDOWN STYLING (Gemini Style) --- */
        /* Links - Clickable & Blue */
        .message p a {color: var(--link-color); text-decoration: none; cursor: pointer;}
        .message p a:hover {text-decoration: underline;}

        .message p strong{font-weight:700; color: var(--text-color)}
        .message p code{background-color:var(--hover-color);border-radius:4px;padding:2px 6px;font-family:var(--mono-font);font-size:.9em; color: var(--accent-color);}
        
        /* Code Blocks */
        .message pre {
            background-color: var(--code-bg);
            border-radius: 8px;
            margin: 12px 0;
            border: 1px solid var(--hover-color);
            position: relative;
            overflow: hidden;
        }
        
        /* Header for Code Block */
        .code-header-bar {
            background-color: var(--code-header-bg);
            padding: 6px 12px;
            font-size: 11px;
            color: var(--secondary-text-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--hover-color);
            font-family: var(--font-family);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message pre code {
            display: block;
            padding: 16px;
            overflow-x: auto;
            background-color: transparent;
            color: var(--text-color);
            border-radius: 0;
            font-family: var(--mono-font);
            font-size: 13px;
            line-height: 1.5;
        }

        /* Copy Button inside Code Block */
        .copy-code-btn {
            background: transparent;
            border: none;
            color: var(--secondary-text-color);
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: color 0.2s;
        }
        .copy-code-btn:hover { color: var(--text-color); }

        .message p ul, .message p ol {margin-left: 20px; margin-bottom: 10px;}
        .message p table {width: 100%; border-collapse: collapse; margin: 10px 0;}
        .message p th, .message p td {border: 1px solid var(--secondary-text-color); padding: 8px;}
        
        /* Animations */
        .thinking-animation{display:flex;align-items:center;gap:6px;padding:10px 0}
        .typing-dot{width:6px;height:6px;background-color:var(--secondary-text-color);border-radius:50%;animation:bounce 1.4s infinite ease-in-out both}
        .typing-dot:nth-child(1){animation-delay:-.32s}.typing-dot:nth-child(2){animation-delay:-.16s}
        @keyframes bounce{0%,100%,80%{transform:scale(0)}40%{transform:scale(1)}}
        
        .cursor{display:inline-block;width:8px;height:18px;background-color:var(--accent-color);animation:blink 1s step-end infinite;vertical-align:text-bottom;margin-left:2px}
        @keyframes blink{50%{opacity:0}}

        /* Actions */
        .message-actions{display:flex;gap:10px;align-items:center;margin-top:6px;opacity:0;transition:opacity .2s;height:20px}
        .message:hover .message-actions{opacity:1}
        .action-icon{cursor:pointer;color:var(--secondary-text-color);font-size:14px;padding:4px}
        
        /* Input Area */
        .input-area{padding:10px 16px 20px;background-color:var(--background-color);flex-shrink:0;width:100%;position:relative;z-index: 10;}
        .image-preview-container {max-width: 800px;margin: 0 auto 8px auto;padding: 0 12px;display: none;}
        .preview-wrapper {position: relative;display: inline-block;background: var(--surface-color);padding: 6px;border-radius: 10px;border: 1px solid var(--secondary-text-color);}
        .preview-thumb {height: 50px;width: auto;border-radius: 4px;display: block;}
        .remove-img-btn {position: absolute;top: -8px;right: -8px;background: var(--surface-color);border: 1px solid var(--secondary-text-color);color: var(--text-color);border-radius: 50%;width: 20px;height: 20px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:10px}

        .input-wrapper{max-width:800px;margin:0 auto;display:flex;align-items:flex-end;background-color:var(--surface-color);border-radius:24px;padding:8px 12px;border: 1px solid transparent;transition: border-color 0.2s;}
        .input-wrapper:focus-within{border-color: var(--secondary-text-color)}
        .input-wrapper #user-input{flex-grow:1;border:none;background:0 0;color:var(--text-color);padding:8px 8px 8px 4px;font-size:16px;outline:0;resize:none;max-height:120px;overflow-y:auto;min-height: 24px; line-height: 24px;}
        .icon-btn{background:0 0;border:none;color:var(--text-color);font-size:18px;cursor:pointer;padding:10px;border-radius:50%;transition:background-color .2s;display:flex;justify-content:center;align-items:center;flex-shrink: 0;}
        .icon-btn:hover{background-color:var(--hover-color)}
        #send-btn{background-color: var(--text-color); color: var(--background-color); width: 36px; height: 36px; padding: 0;}
        
        /* Stop Button Styling (Gemini Style) */
        #send-btn.is-stopping {
            background-color: var(--surface-color);
            border: 2px solid var(--text-color); 
            color: var(--text-color);
            font-size: 12px; /* Smaller icon */
        }
        
        .disclaimer{font-size:11px;color:var(--secondary-text-color);text-align:center;padding-top:8px;max-width:800px;margin:0 auto}

        /* Modals & Toasts */
        .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background-color:var(--surface-color);color:var(--text-color);padding:12px 24px;border-radius:8px;z-index:200;box-shadow:0 4px 12px rgba(0,0,0,.3);opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s,bottom .3s; white-space: nowrap; font-size: 14px;}
        .toast.show{bottom:40px;opacity:1;visibility:visible}
        .confirm-toast{width:90%;max-width:300px;text-align:center; white-space: normal;}
        .confirm-toast .toast-buttons{display:flex;justify-content:center;gap:12px;margin-top:16px}
        .confirm-toast button{border:none;padding:6px 16px;border-radius:20px;cursor:pointer;font-weight:500}
        .confirm-toast .confirm-yes{background-color:var(--danger-color);color:#fff}.confirm-toast .confirm-no{background-color:var(--hover-color);color:var(--text-color)}
        
        .toggle-switch{display:flex;align-items:center;justify-content:space-between;width:100%}.switch{position:relative;display:inline-block;width:34px;height:20px}.switch input{opacity:0;width:0;height:0}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#555;transition:.4s;border-radius:34px}.slider:before{position:absolute;content:"";height:12px;width:12px;left:4px;bottom:4px;background-color:#fff;transition:.4s;border-radius:50%}.switch input:checked+.slider{background-color:var(--accent-color)}.switch input:checked+.slider:before{transform:translateX(14px)}
        
        /* Account & Terms */
        .account-modal,.terms-modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background-color:var(--surface-color);border-radius:12px;box-shadow:0 5px 25px rgba(0,0,0,.6);z-index:1001;width:90%;max-width:400px;padding:24px;display:none}
        .account-modal h2,.terms-modal h2{margin-bottom:20px;text-align:center; font-size: 1.2rem;}
        .form-group{margin-bottom:16px}.form-group label{display:block;margin-bottom:8px;font-size:13px;color:var(--secondary-text-color)}.form-group input{width:100%;padding:10px;border-radius:6px;border:1px solid var(--secondary-text-color);background-color:var(--background-color);color:var(--text-color);font-size:16px}
        .avatar-selection{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}.avatar-choice{width:45px;height:45px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:border-color .2s;object-fit:cover; display: flex; align-items: center; justify-content: center; background-color: var(--background-color);}.avatar-choice.selected{border-color:var(--accent-color)}
        .modal-buttons{display:flex;justify-content:flex-end;gap:12px;align-items:center;margin-top:24px}.delete-btn{background:0 0;border:none;color:var(--danger-color);cursor:pointer;font-size:13px;margin-right:auto}.save-btn{background-color:var(--accent-color);border:none;color:var(--background-color);padding:8px 20px;border-radius:20px;cursor:pointer;font-weight:700}
        .terms-content{max-height:250px;overflow-y:auto;padding-right:8px;margin-bottom:20px;font-size:13px;line-height:1.5;color:var(--secondary-text-color); background: var(--background-color); padding: 10px; border-radius: 8px;}
        .terms-content h3{color:var(--text-color);margin-top:12px;margin-bottom:6px; font-size: 14px;}
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.6);z-index:100;display:none;opacity:0;transition:opacity .3s ease}.modal-overlay.show{display:block;opacity:1}
        
        .options-menu-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);z-index:100;display:none;opacity:0;transition:opacity .3s ease}.options-menu-overlay.show{display:block;opacity:1}
        .options-menu{position:fixed;bottom:0;left:0;width:100%;background-color:var(--surface-color);border-top-left-radius:16px;border-top-right-radius:16px;z-index:101;padding:16px 32px;transform:translateY(100%);transition:transform .3s ease-out}.options-menu.show{transform:translateY(0)}
        .options-menu-header{display:flex;justify-content:center;margin-bottom:16px}.options-menu-handle{width:40px;height:4px;background-color:var(--secondary-text-color);border-radius:2px}
        .options-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;text-align:center;margin-bottom:24px}
        .option-item{display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer}.option-item .icon{width:48px;height:48px;background-color:var(--background-color);border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:20px}.option-item span{font-size:12px}
        .options-list{list-style:none}.options-list li{padding:14px 0;border-top:1px solid var(--hover-color);display:flex;align-items:center;gap:16px;cursor:pointer}

        /* Identity Widget Overrides */
        [data-netlify-identity-widget]{--modal-background:var(--background-color);--text-color:var(--text-color);--primary-color:var(--accent-color);--input-background:var(--surface-color);}
        .sidebar-list .chat-title-wrapper{display:flex;align-items:center;width:100%;gap:12px; overflow: hidden;}.sidebar-list .chat-title-text{flex-grow:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .sidebar-list li .delete-chat-btn{margin-left:auto;visibility:hidden;opacity:0;transition:opacity .2s ease;font-size:14px;padding:4px}.sidebar-list li:hover .delete-chat-btn{visibility:visible;opacity:1}
        .sidebar-list li .delete-chat-btn:hover{color:var(--danger-color)}
        
        @media(max-width: 600px) {
            .sidebar{width: 80%;}
            .content-wrapper{padding-top: 10px;}
            .greeting h1{font-size: 2.2rem;}
            .message{max-width: 100%;}
            .message.user{max-width: 95%;}
            .input-area{padding-bottom: 30px;} /* Extra padding for mobile gestures */
        }
    </style>
</head>
<body>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header"><button class="close-btn" id="close-sidebar-btn"><i class="fas fa-times"></i></button><div class="title">RansGPT</div></div>
        <div class="sidebar-content">
            <ul class="sidebar-list"><li id="new-chat-btn"><i class="fas fa-edit"></i> New Chat</li></ul>
            <div class="sidebar-section"><h3>Recent</h3><ul class="sidebar-list" id="recent-chats-list"></ul></div>
            <div class="sidebar-section"><h3>Settings</h3><ul class="sidebar-list"><li><div class="toggle-switch"><span><i class="fas fa-moon"></i> Dark Theme</span><label class="switch"><input type="checkbox" id="theme-toggle"><span class="slider"></span></label></div></li></ul></div>
        </div>
        <div class="sidebar-credit">Made by Ransara Devnath</div>
    </aside>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    
    <div class="app-container">
        <div class="top-bar">
            <div class="menu-icon" id="menu-icon"><i class="fas fa-bars"></i></div>
            <div class="title">RansGPT</div>
            <div class="profile-icon-container" id="profile-icon-container">
                <div class="profile-icon"><i class="fas fa-user"></i></div>
            </div>
        </div>
        
        <main class="main-content" id="main-content">
            <div class="content-wrapper">
                <div id="welcome-container">
                    <div class="greeting"><h1>Hello, Guest</h1><p>How can I help you today?</p></div>
                    <div class="suggestion-cards">
                        <div class="card" data-prompt="Write a story about a friendly robot"><p>Write a story about a friendly robot</p><div class="card-icon"><i class="fas fa-pen"></i></div></div>
                        <div class="card" data-prompt="Explain quantum computing"><p>Explain quantum computing</p><div class="card-icon"><i class="fas fa-lightbulb"></i></div></div>
                        <div class="card" data-prompt="Ideas for a weekend trip"><p>Ideas for a weekend trip</p><div class="card-icon"><i class="fas fa-compass"></i></div></div>
                        <div class="card" data-prompt="Workout plan for beginners"><p>Workout plan for beginners</p><div class="card-icon"><i class="fas fa-dumbbell"></i></div></div>
                    </div>
                </div>
                <div class="chat-box" id="chat-box"></div>
            </div>
        </main>
        
        <div class="input-area" id="input-area">
            <div class="image-preview-container" id="image-preview-container">
                <div class="preview-wrapper">
                    <img src="" id="image-preview" class="preview-thumb">
                    <button class="remove-img-btn" id="remove-img-btn"><i class="fas fa-times"></i></button>
                </div>
            </div>

            <div class="input-wrapper">
                <button class="icon-btn" id="plus-btn"><i class="fas fa-plus"></i></button>
                <input type="file" id="file-input" accept="image/*" style="display: none;"> 
                <textarea id="user-input" placeholder="Ask RansGPT" rows="1"></textarea>
                <button class="icon-btn" id="mic-btn"><i class="fas fa-microphone"></i></button>
                <button class="icon-btn" id="send-btn" style="display:none"><i class="fas fa-arrow-up"></i></button>
            </div>
            <p class="disclaimer">RansGPT can make mistakes. Consider checking important information.</p>
        </div>
    </div>

    <div class="options-menu-overlay" id="options-menu-overlay"></div>
    <div class="options-menu" id="options-menu">
        <div class="options-menu-header"><div class="options-menu-handle"></div></div>
        <div class="options-grid">
            <div class="option-item" id="redo-btn"><div class="icon"><i class="fas fa-redo"></i></div><span>Redo</span></div>
            <div class="option-item" id="read-btn"><div class="icon"><i class="fas fa-volume-up"></i></div><span>Read</span></div>
            <div class="option-item" id="share-btn-grid"><div class="icon"><i class="fas fa-share-alt"></i></div><span>Share</span></div>
            <div class="option-item" id="copy-btn-grid"><div class="icon"><i class="fas fa-copy"></i></div><span>Copy</span></div>
        </div>
    </div>

    <div class="modal-overlay" id="account-modal-overlay"></div>
    <div class="account-modal" id="account-modal">
        <h2>Account Settings</h2>
        <div class="form-group"><label for="user-name-input">Your Name</label><input type="text" id="user-name-input" placeholder="Enter your name"></div>
        <div class="form-group"><label>Choose Your Avatar</label><div class="avatar-selection" id="avatar-selection"></div></div>
        <div class="modal-buttons"><button class="delete-btn" id="delete-account-btn">Delete Account</button><button class="save-btn" id="save-account-btn">Save</button></div>
    </div>

    <div class="modal-overlay" id="terms-modal-overlay"></div>
    <div class="terms-modal" id="terms-modal">
        <h2>Welcome to RansGPT!</h2>
        <div class="terms-content">
            <h3>About RansGPT</h3>
            <p>This is a personalized AI assistant.<br><br>- <b>Made by:</b> Ransara Devnath<br>- <b>Model:</b> Gemini 1.5 Flash<br><br>Special thanks to the Google Gemini API.</p>
            <h3>Terms and Conditions</h3>
            <p>By using RansGPT, you agree not to misuse the service. Your conversation history is stored locally on your device for convenience. Do not share sensitive personal information.</p>
        </div>
        <div class="modal-buttons"><button class="delete-btn" id="deny-terms-btn">Exit</button><button class="save-btn" id="accept-terms-btn">I Agree</button></div>
    </div>

    <div class="toast" id="toast"></div>
    <div class="toast confirm-toast" id="confirm-toast">
        <p id="confirm-toast-message"></p>
        <div class="toast-buttons"><button class="confirm-no" id="confirm-no-btn">No</button><button class="confirm-yes" id="confirm-yes-btn">Yes</button></div>
    </div>

    <script>
        // --- CONFIGURE MARKED (Safe & Clickable Links) ---
        // This ensures every URL opens in a new tab (target="_blank")
        const renderer = new marked.Renderer();
        renderer.link = function(href, title, text) {
            return `<a href="${href}" target="_blank" rel="noopener noreferrer">${text}</a>`;
        };
        // Ensure Code Blocks are handled properly
        renderer.code = function(code, language) {
            const validLang = language || 'Text';
            return `<pre><div class="code-header-bar"><span>${validLang}</span><button class="copy-code-btn"><i class="fas fa-copy"></i> Copy</button></div><code>${code}</code></pre>`;
        };

        marked.setOptions({
            renderer: renderer,
            gfm: true,
            breaks: true,
            headerIds: false
        });

        // --- DOM Elements ---
        const mainContent = document.getElementById('main-content');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const menuIcon = document.getElementById('menu-icon');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const welcomeContainer = document.getElementById('welcome-container');
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const micBtn = document.getElementById('mic-btn');
        const suggestionCards = document.querySelectorAll('.card');
        const plusBtn = document.getElementById('plus-btn');
        
        const fileInput = document.getElementById('file-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const removeImgBtn = document.getElementById('remove-img-btn');

        const optionsMenuOverlay = document.getElementById('options-menu-overlay');
        const optionsMenu = document.getElementById('options-menu');
        const toast = document.getElementById('toast');
        const confirmToast = document.getElementById('confirm-toast');
        const themeToggle = document.getElementById('theme-toggle');
        const recentChatsList = document.getElementById('recent-chats-list');
        const newChatBtn = document.getElementById('new-chat-btn');
        const profileIconContainer = document.getElementById('profile-icon-container');
        const accountModal = document.getElementById('account-modal');
        const accountModalOverlay = document.getElementById('account-modal-overlay');
        const userNameInput = document.getElementById('user-name-input');
        const avatarSelectionContainer = document.getElementById('avatar-selection');
        const saveAccountBtn = document.getElementById('save-account-btn');
        const deleteAccountBtn = document.getElementById('delete-account-btn');
        const greetingH1 = document.querySelector('.greeting h1');
        const termsModal = document.getElementById('terms-modal');
        const termsModalOverlay = document.getElementById('terms-modal-overlay');

        // --- State ---
        let currentChat = [], allChats = {}, currentChatId = null, apiRequestController, currentMessageText = "";
        const avatarOptions = ["icon", "https://files.catbox.moe/6j6s3e.png", "https://files.catbox.moe/x9w3tq.png", "https://files.catbox.moe/q3f3a5.png"];
        let tempSelectedAvatar = "icon";
        let currentImageBase64 = null;

        // --- Helper Functions ---
        const showToast = (msg) => { toast.textContent = msg; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 3000); };
        
        function addMessage(message, sender, isThinking = false, imageUrl = null) {
            showChatView();
            const messageId = 'msg-' + Date.now();
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', sender);
            messageElement.id = messageId;
            
            // Avatar Logic
            let avatar;
            if (sender === 'user') {
                const user = netlifyIdentity.currentUser();
                const avatarSrc = user?.user_metadata?.avatar || 'icon';
                if (avatarSrc === 'icon') {
                    avatar = document.createElement('div'); avatar.classList.add('avatar'); avatar.innerHTML = `<i class="fas fa-user"></i>`;
                } else {
                    avatar = document.createElement('img'); avatar.classList.add('avatar'); avatar.src = avatarSrc;
                }
            } else {
                avatar = document.createElement('img'); avatar.classList.add('avatar'); avatar.src = 'https://files.catbox.moe/fj08ro.jpg';
            }
            messageElement.appendChild(avatar);

            const messageContent = document.createElement('div');
            messageContent.classList.add('message-content');
            
            if (imageUrl) {
                const img = document.createElement('img'); img.src = imageUrl; img.classList.add('chat-image');
                messageContent.appendChild(img);
            }

            if (isThinking) {
                messageContent.innerHTML = `<div class="thinking-animation"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
            } else {
                const p = document.createElement('p');
                if (sender === 'bot') {
                    // Pre-render if history load
                    if(message) {
                        p.innerHTML = DOMPurify.sanitize(marked.parse(message), { ADD_ATTR: ['target'] });
                        setupCodeCopy(p); // Attach copy events to buttons
                    }
                } else {
                    p.textContent = message;
                }
                messageContent.appendChild(p);
                
                if (sender === 'bot' && !isThinking) {
                    const actions = document.createElement('div'); actions.classList.add('message-actions');
                    actions.innerHTML = `<i class="fas fa-redo-alt action-icon regenerate-btn"></i><i class="fas fa-ellipsis-h action-icon options-btn"></i>`;
                    messageContent.appendChild(actions);
                    actions.querySelector('.options-btn').addEventListener('click', () => showOptionsMenu(message));
                    actions.querySelector('.regenerate-btn').addEventListener('click', () => { 
                        messageElement.remove();
                        currentChat.pop(); // remove bot
                        const lastUser = currentChat.pop(); // get user
                        if(lastUser) sendMessage(lastUser.text);
                    });
                }
            }
            messageElement.appendChild(messageContent);
            chatBox.appendChild(messageElement);
            scrollToBottom();
            return messageId;
        }

        // --- OPTIMIZED TYPEWRITER FUNCTION ---
        async function typeMessage(text, messageId) {
            const msgElement = document.getElementById(messageId);
            if (!msgElement) return;
            const p = msgElement.querySelector('p');
            const messageContent = msgElement.querySelector('.message-content');
            
            // 1. Stream raw text first for smoothness
            let i = 0;
            const speed = 10; 
            p.innerHTML = '<span class="cursor"></span>'; 
            
            await new Promise(resolve => {
                function typeLoop() {
                    if (i < text.length) {
                        const chunk = text.slice(i, i + 3); 
                        i += 3;
                        p.firstChild.textContent += chunk; 
                        scrollToBottom();
                        requestAnimationFrame(() => setTimeout(typeLoop, speed));
                    } else {
                        resolve();
                    }
                }
                typeLoop();
            });

            // 2. Once typing done, Render Markdown (Links will be clickable)
            const finalHtml = marked.parse(text);
            p.innerHTML = DOMPurify.sanitize(finalHtml, { ADD_ATTR: ['target'] });
            setupCodeCopy(p);

            // 3. Add actions
            const actions = document.createElement('div'); actions.classList.add('message-actions');
            actions.innerHTML = `<i class="fas fa-redo-alt action-icon regenerate-btn"></i><i class="fas fa-ellipsis-h action-icon options-btn"></i>`;
            messageContent.appendChild(actions);
            actions.querySelector('.options-btn').addEventListener('click', () => showOptionsMenu(text));
             actions.querySelector('.regenerate-btn').addEventListener('click', () => { 
                msgElement.remove();
                currentChat.pop();
                const lastUser = currentChat.pop(); 
                if(lastUser) sendMessage(lastUser.text);
            });
            scrollToBottom();
        }

        function scrollToBottom() {
             mainContent.scrollTo({ top: mainContent.scrollHeight, behavior: 'smooth' });
        }

        // Hook up the Copy Buttons inside Code Blocks
        function setupCodeCopy(p) {
            p.querySelectorAll('pre').forEach(pre => {
                const btn = pre.querySelector('.copy-code-btn');
                const code = pre.querySelector('code');
                if(btn && code) {
                    btn.onclick = () => {
                        navigator.clipboard.writeText(code.innerText).then(() => {
                            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                            setTimeout(() => { btn.innerHTML = '<i class="fas fa-copy"></i> Copy'; }, 2000);
                        });
                    };
                }
            });
        }

        // --- CHAT LOGIC ---
        async function sendMessage(queryText) {
            const query = queryText || userInput.value.trim();
            const image = currentImageBase64;
            
            if (!query && !image) return;
            
            // UI Reset
            userInput.value = ''; userInput.style.height = 'auto';
            currentImageBase64 = null; fileInput.value = ''; imagePreviewContainer.style.display = 'none';
            toggleSendButton();

            // Add User Msg
            addMessage(query, 'user', false, image);
            
            // Update History
            const userMsgObj = { sender: 'user', text: query };
            if(image) userMsgObj.file = { type: 'image/jpeg', url: image };
            currentChat.push(userMsgObj);
            
            // Add Thinking
            const thinkingId = addMessage('', 'bot', true);
            
            apiRequestController = new AbortController();
            try {
                const res = await fetch('/.netlify/functions/chat', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ history: currentChat }),
                    signal: apiRequestController.signal
                });
                
                document.getElementById(thinkingId)?.remove();
                
                if (!res.ok) throw new Error('API Error');
                const data = await res.json();
                
                // Add Bot Msg Placeholder and Type
                const botMsgId = addMessage('', 'bot');
                currentChat.push({ sender: 'bot', text: data.reply });
                await typeMessage(data.reply, botMsgId);
                
                saveCurrentChat();
            } catch (err) {
                document.getElementById(thinkingId)?.remove();
                if(err.name !== 'AbortError') addMessage("Something went wrong.", "bot");
            } finally {
                apiRequestController = null;
                toggleSendButton();
            }
        }

        // --- UI Interactions ---
        function toggleSendButton() {
            const hasContent = userInput.value.trim() !== '' || currentImageBase64 !== null;
            if (apiRequestController) {
                // STOP MODE - Gemini Style Square
                sendBtn.style.display = 'flex'; 
                sendBtn.classList.add('is-stopping'); 
                sendBtn.innerHTML = '<i class="fas fa-square"></i>'; 
                micBtn.style.display = 'none';
            } else {
                // SEND MODE
                sendBtn.classList.remove('is-stopping'); 
                sendBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
                if(hasContent) { sendBtn.style.display = 'flex'; micBtn.style.display = 'none'; }
                else { sendBtn.style.display = 'none'; micBtn.style.display = 'flex'; }
            }
        }

        // Image Handling
        plusBtn.onclick = () => fileInput.click();
        fileInput.onchange = (e) => {
            const f = e.target.files[0];
            if(f) { 
                const r = new FileReader(); 
                r.onload = (e) => { currentImageBase64 = e.target.result; imagePreview.src = currentImageBase64; imagePreviewContainer.style.display = 'block'; toggleSendButton(); };
                r.readAsDataURL(f); 
            }
        };
        removeImgBtn.onclick = () => { currentImageBase64 = null; fileInput.value = ''; imagePreviewContainer.style.display = 'none'; toggleSendButton(); };

        // Sidebar & Menu
        const toggleSidebar = () => { sidebar.classList.toggle('open'); sidebarOverlay.classList.toggle('open'); };
        menuIcon.onclick = toggleSidebar; closeSidebarBtn.onclick = toggleSidebar; sidebarOverlay.onclick = toggleSidebar;
        
        // Auto-resize textarea
        userInput.addEventListener('input', function() {
            this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; toggleSendButton();
        });
        userInput.onkeydown = (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };

        sendBtn.onclick = () => {
            if(sendBtn.classList.contains('is-stopping')) { apiRequestController?.abort(); }
            else { sendMessage(); }
        };

        // Options Menu
        function showOptionsMenu(text) { currentMessageText = text; optionsMenu.classList.add('show'); optionsMenuOverlay.classList.add('show'); }
        const hideOptionsMenu = () => { optionsMenu.classList.remove('show'); optionsMenuOverlay.classList.remove('show'); };
        optionsMenuOverlay.onclick = hideOptionsMenu;
        
        document.getElementById('copy-btn-grid').onclick = () => { navigator.clipboard.writeText(currentMessageText); showToast('Copied!'); hideOptionsMenu(); };
        document.getElementById('redo-btn').onclick = () => { hideOptionsMenu(); };
        document.getElementById('read-btn').onclick = () => { 
            const u = new SpeechSynthesisUtterance(currentMessageText); window.speechSynthesis.speak(u); hideOptionsMenu(); 
        };
        // Share Button (Mobile Native)
        document.getElementById('share-btn-grid').onclick = () => {
            if (navigator.share) {
                navigator.share({ title: 'RansGPT', text: currentMessageText }).catch(console.error);
            } else {
                navigator.clipboard.writeText(currentMessageText); showToast('Copied to clipboard!');
            }
            hideOptionsMenu();
        };

        // Theme
        const setTheme = (t) => { document.documentElement.setAttribute('data-theme', t); localStorage.setItem('ransgpt_theme', t); themeToggle.checked = t === 'dark'; };
        themeToggle.onchange = () => setTheme(themeToggle.checked ? 'dark' : 'light');
        setTheme(localStorage.getItem('ransgpt_theme') || 'dark');

        // Netlify Identity
        netlifyIdentity.on('init', user => updateUI(user));
        netlifyIdentity.on('login', user => { updateUI(user); netlifyIdentity.close(); if(!localStorage.getItem('terms_ok')) { termsModal.style.display = 'block'; termsModalOverlay.classList.add('show'); } });
        netlifyIdentity.on('logout', () => updateUI(null));
        
        function updateUI(user) {
            profileIconContainer.innerHTML = '';
            if(user) {
                const img = document.createElement('img'); img.classList.add('profile-icon'); img.src = user.user_metadata.avatar || 'https://files.catbox.moe/fj08ro.jpg'; 
                img.onclick = () => openProfileDropdown(user);
                profileIconContainer.appendChild(img);
                greetingH1.textContent = `Hello, ${user.user_metadata.full_name || user.email.split('@')[0]}`;
                loadUserSpecificData(user);
            } else {
                 profileIconContainer.innerHTML = '<div class="profile-icon" onclick="netlifyIdentity.open()"><i class="fas fa-user"></i></div>';
                 showWelcomeView();
                 greetingH1.textContent = "Hello, Guest";
            }
        }

        // Dropdown
        function openProfileDropdown(user) {
            let d = document.querySelector('.profile-dropdown');
            if(!d) {
                d = document.createElement('div'); d.className = 'profile-dropdown';
                d.innerHTML = `<ul><li id="acc-set"><i class="fas fa-cog"></i> Settings</li><li id="acc-out" class="danger"><i class="fas fa-sign-out-alt"></i> Logout</li></ul>`;
                profileIconContainer.appendChild(d);
                d.querySelector('#acc-set').onclick = openAccountSettings;
                d.querySelector('#acc-out').onclick = () => netlifyIdentity.logout();
            }
            d.classList.toggle('show');
            // Close if clicked outside
            const closeDropdown = (e) => {
                if(!profileIconContainer.contains(e.target)) {
                    d.classList.remove('show');
                    window.removeEventListener('click', closeDropdown);
                }
            };
            setTimeout(() => window.addEventListener('click', closeDropdown), 10);
        }

        // Account Settings
        function openAccountSettings() {
            const user = netlifyIdentity.currentUser();
            userNameInput.value = user.user_metadata.name || '';
            avatarSelectionContainer.innerHTML = '';
            avatarOptions.forEach(src => {
                const div = document.createElement('img'); div.className = 'avatar-choice'; div.src = src === 'icon' ? 'https://files.catbox.moe/fj08ro.jpg' : src;
                if((user.user_metadata.avatar || 'icon') === src) div.classList.add('selected');
                div.onclick = () => { document.querySelectorAll('.avatar-choice').forEach(e=>e.classList.remove('selected')); div.classList.add('selected'); tempSelectedAvatar = src; };
                avatarSelectionContainer.appendChild(div);
            });
            accountModal.style.display = 'block'; accountModalOverlay.classList.add('show');
        }
        
        saveAccountBtn.onclick = () => {
            const user = netlifyIdentity.currentUser();
            user.update({ data: { name: userNameInput.value, avatar: tempSelectedAvatar } }).then(u => { updateUI(u); accountModal.style.display = 'none'; accountModalOverlay.classList.remove('show'); showToast("Saved!"); });
        };
        accountModalOverlay.onclick = () => { accountModal.style.display = 'none'; accountModalOverlay.classList.remove('show'); };

        // History Management
        function loadUserSpecificData(user) {
            allChats = JSON.parse(localStorage.getItem(`chats_${user.id}`) || '{}');
            renderHistoryList();
        }
        function saveCurrentChat() {
            const user = netlifyIdentity.currentUser();
            if(!user || currentChat.length === 0) return;
            if(!currentChatId) currentChatId = Date.now().toString();
            allChats[currentChatId] = { title: currentChat[0].text.substring(0, 30), msgs: currentChat };
            localStorage.setItem(`chats_${user.id}`, JSON.stringify(allChats));
            renderHistoryList();
        }
        function renderHistoryList() {
            recentChatsList.innerHTML = '';
            Object.keys(allChats).reverse().forEach(id => {
                const li = document.createElement('li');
                li.innerHTML = `<div class="chat-title-wrapper"><i class="far fa-comment-alt"></i><span class="chat-title-text">${allChats[id].title}</span></div><i class="fas fa-trash-alt delete-chat-btn"></i>`;
                li.onclick = () => loadChat(id);
                li.querySelector('.delete-chat-btn').onclick = (e) => { e.stopPropagation(); delete allChats[id]; localStorage.setItem(`chats_${netlifyIdentity.currentUser().id}`, JSON.stringify(allChats)); renderHistoryList(); if(currentChatId === id) startNewChat(); };
                recentChatsList.appendChild(li);
            });
        }
        function loadChat(id) {
            currentChatId = id; currentChat = allChats[id].msgs;
            chatBox.innerHTML = ''; showChatView();
            currentChat.forEach(m => addMessage(m.text, m.sender, false, m.file?.url));
            if(sidebar.classList.contains('open')) toggleSidebar();
        }
        
        newChatBtn.onclick = startNewChat;
        function startNewChat() { currentChat = []; currentChatId = null; showWelcomeView(); if(sidebar.classList.contains('open')) toggleSidebar(); }

        function showWelcomeView() { welcomeContainer.style.display = 'block'; chatBox.style.display = 'none'; }
        function showChatView() { welcomeContainer.style.display = 'none'; chatBox.style.display = 'flex'; }
        
        suggestionCards.forEach(c => c.onclick = () => sendMessage(c.dataset.prompt));
        
        // Terms
        document.getElementById('accept-terms-btn').onclick = () => { localStorage.setItem('terms_ok', 'true'); termsModal.style.display = 'none'; termsModalOverlay.classList.remove('show'); };
        document.getElementById('deny-terms-btn').onclick = () => netlifyIdentity.logout();

    </script>
</body>
</html>